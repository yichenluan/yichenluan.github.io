---
title: DBDB: Dog Bed Database
layout: post
tags:
  - Database
---


##Introduction

DBDB (Dog Bed Database) 是一个实现了简单 key/value 数据库的 Python 库。它将键和值进行关联，并把这种关联关系存储到磁盘上用于之后的访问。

DBDB 旨在电脑崩溃或者其他错误条件下也能保证数据的安全。它也避免了把所有的数据都存在内存当中，这样，用户就可以存储比内存容量更大的数据。

##Why is it Interesting?

大多数项目都在某种程度上使用到了数据库。你确实不需要自己写一个，就算是将 json 数据存储到磁盘上，数不尽的边缘情况也会把你搞崩溃。

- 当存储空间不足时会发生什么？
- 当数据正在存储，但是笔记本没电了，会发生什么？
- 当数据大小比可用内存空间还要大，会发生什么？

尽管如此，实现一个自己的数据库是一个非常好的方法来理解一个数据库系统如何处理这些情况。


我们这里讨论的技术和概念应该要能够处理各种情况。

说道不足之处。。。

##Characterizing Failure

数据库的评判标准在于多大程度的遵守了 ACID 属性：atomicity（原子性）、consistency（一致性）、isolation（独立性）、durability（持久性）。

DBDB 的数据更新保证了原子性和持久性。这两个属性就会在后面的章节介绍。由于没有对数据存储做限制，DBDB无法保证一致性；独立性也统一没有实现。

应用程序自身是可以保证自己的一致性，但是在数据库中实现一致性需要一个事务管理器。我们没有在这里试图实现它，不过，你可以在[CircleDB chapter](http://aosabook.org/en/500L/an-archaeology-inspired-database.html)进一步了解事务管理器。

我们同事还有别的一些系统维护的问题需要考虑。旧数据（Stale data）在 DBDB 中不会进行回收处理，因此，不断的更新最终将消耗掉所有的磁盘空间。PostgreSQL 把处理陈旧数据的过程称之为“吸尘(vacuuming)”，这使得旧的行空间可以重新使用，CouchDB 把处理陈旧数据的过程称之为“压缩”，通过把正常数据(live data)的部分重写入新文件，并替代旧的文件。

DBDB 能够添加“压缩”这个功能，不过这就留作读者的练习了。

##The Architecture of DBDB

DBDB 把物理层（数据是如何存储在文件当中）和逻辑层（数据的逻辑结构 - 在这里是二叉树）从 key/value 存储相关的内容分离开来。

许多数据库豆浆逻辑层和物理层分离开来，这样能有效地提供不同的实现来获得不同的性能特性。比如说，DB2的SMS(文件系统中的文件)和DMS(原始块设备)或MySQL的替代引擎。

##Discovering the Design

在本文中，我们假设 DBDB 是一个完整的项目，然后去了解它的流程和逻辑。让我们先从整个项目的结构开始吧。

###Organisational Units

以下文件按照一个普通用户所需要了解的程度来排列。

- `tool.py` 提供了一个在终端使用数据库的命令行工具。